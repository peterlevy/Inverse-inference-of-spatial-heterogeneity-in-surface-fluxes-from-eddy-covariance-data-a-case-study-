\section{Introduction}\label{introduction}

\subsection{A framework for accounting for spatial heterogeneity in flux
measurements}\label{a-framework-for-accounting-for-spatial-heterogeneity-in-flux-measurements}

Eddy covariance has become a widely used technique for measuring
surface-atmosphere exchange of energy and scalars (Baldocchi \emph{et
al.} , 2001). The technique has advantages in that it integrates over a
relatively large area (compared to chamber methods), and can run
near-continuously over long time spans. It can thereby provide the best
available data with which to estimate the magnitude and controls on
ecosystem-scale trace gas and energy fluxes. An implicit assumption in
the method is horizontal homogeneity in the wind field and surface flux
(Aubinet \emph{et al.} , 2012). Horizontal heterogeneity in the wind
field is associated with problems of flux divergence, and the
misinterpretation of advective fluxes as part of the vertical eddy flux
(Aubinet \emph{et al.} , 2002, Finnigan \emph{et al.} (2003)). Horizontal
heterogeneity in the surface flux causes difficulties in interpretation
and raises questions such as: what area do our observations actually
represent? Given the area we want to make inferences about, how
representative are our observed fluxes? (Kumar \emph{et al.} , 2016). Our
aim here was to address these questions, using statistical modelling and
footprint analysis, applied to a case study of methane fluxes in a
subarctic mire.
\cite{Schaepman-Strub2009}
In previous work, the simplest and most common approach to dealing with
spatial heterogeneity has been to define sectors in the wind rose based
on prior knowledge, and treat these as independent sub-sets of the data.
For example, (Jones \emph{et al.} , 2016) located an eddy covariance
tower on a boundary between two fields, and allocated observations to
data sets for either the north field or the south field, depending on
the mean wind vector for each half-hour. In a case study which we
examine further here, (Jammet \emph{et al.} , 2017) used an eddy
covariance tower located at the edge of a lake in a subarctic mire
ecosystem (Figure \ref{fig:fp_on_map_Stordalen}), and allocated
observations to data sets for the lake or mire, depending on the mean
wind vector for each half-hour.

Rather than simply considering the azimuth angle of the mean wind
vector, a more advanced step is to consider the way in which eddy
covariance measurements are influenced by the so-called ``flux
footprint'' (Schuepp \emph{et al.} , 1990, Schmid \& Oke (1990), Leclerc
\& Foken (2014)). This quantifies the area upwind of the tower which has
contributed to the measured flux in a given time period, governed by
wind speed, direction, turbulence characteristicss and atmospheric
stability. The footprint defines the relative contribution of each
element of the surface area to the measured vertical flux.
Mathematically, it is fundamentally defined by the advection-diffusion
equation. Models of the footprint have used analytical approximations to
the advection/diffusion equation (based on K-theory and power-law
approximations of the wind and diffusivity profles)(Horst \& Weil,
1992), stochastic Lagrangian approaches, or large-eddy simulation. For
computational reasosns, the first of these is the most common approach.

The footprint acts as a weighting function, such that some grid cells
contribute strongly to the measured flux, and others not at all (Figure
\ref{fig:fp_on_map_Stordalen}). In mathematical terms, the mean flux
\(F\) of a scalar over a landscape represented by a gridded domain with
dimensions \(n_x\) by \(n_y\) at time \(t\) is given by:

\begin{align}
   \label{eq:simpleMean} 
  \bar{F_t} = \sum_{x = 1}^{n_x} \sum_{y = 1}^{n_y} F_{xyt} \frac{1}{n_x n_y}

\end{align}

Eddy covariance effectively measures a weighted mean, where the
footprint provides the set of weights, \(\mathbf{W}\), to give:

\begin{align}
   \label{eq:weightMean} 
  \widehat{\bar{F_t}} = \sum_{x = 1}^{n_x} \sum_{y = 1}^{n_y} F_{xyt} W_{xyt}

\end{align}

where we use the \(\widehat{\mathrm{hat}}\)-symbol to indicate that this
is an estimator, not \(\bar{F_t}\) itself. The weights
\(\mathbf{W} = \{W_{xy}\}\) sum to unity at each time interval. We
typically have a large number of measurements over time (\(n_t\),
potentially all the half-hourly flux measurements over a number of
years). If the number of samples is large, heterogeneity is small,
and/or the footprint is large in relation to the domain of interest, we
can assume \(\widehat{\bar{F}}\) is a reasonable approximation of the
true time-averaged mean flux for the whole domain, i.e.
\(\widehat{\bar{F}} \approx \bar{F}\). In many circumstances, this may
not be the case. To extract the complete information from the data about
spatial heterogeneity of the surface flux, we would wish to know the
mean flux at each location, \(\bar{F_{xy}}\). However, this is a
nonlinear inverse problem which is very under-constrained, with no
analytical solution. Our goal here is to find the appropriate balance in
identifying and accounting for spatial heterogeneity as far as possible,
whilst keeping the model reasonably simple and identifiable.

Fluxes measured by eddy covariance are typically analysed as a time
series, where the temporal variation in \(F\) is related to variation in
independent temporal covariates \(X\), such as solar radiation, air
temperature and soil moisture, measured at a single point near the flux
tower. Ignoring autocorelation and nonlinear processes for the moment,
this can often be achieved using a multiple regression model with matrix
of coefficients \(\boldsymbol{\beta}\) and a residual error term
\(\epsilon\):

\begin{align}
   \label{eq:timeVarn} 
  \widehat{\bar{F_t}} = \boldsymbol{\beta} \mathbf{X}_t + \epsilon_{t}

\end{align}

In the presence of spatial heterogeneity in \(F\) around the tower, this
approach is incomplete, and additional terms should be considered in the
analysis. Most simply, we can add a term for spatial variation \emph{per
se} (i.e.~variation which is not accounted for by covariates, but has
some pattern in space). To do this, we can use the ``mixed-effects''
(aka ``multi-level'') modelling approach (Laird \& Ware, 1982, Pinheiro
\& Bates (2006), Bates \emph{et al.} (2015)). Mixed-effects modelling is
a development of the linear regression paradigm, where the variance
components (or ``error structure'') of the data are explicitly
represented and accounted for, so as to overcome assumptions of
independence between samples. ``Fixed effects'' are usually the
phenomena of real interest, such as effects of temperature or CO\(_2\)
on plant growth. ``Random effects'' represent structure in the data,
often introduced by experimental design, which explain some of the
variability, but are not usually the prime focus. Examples include
spatial blocks in agricultural experiments, and individual subjects in
medical experiments. We are interested in an overall, global response to
a treatment (fixed effect), but are aware that the observations and
groups of observations come from samples (randomly) drawn from a wider
population. On average, these samples are unbiased, but this population
has variance \(\Psi\), and this has an influence on the observations we
make in any particular experiment. We account for this by estimating
\(\Psi\) from the sample data. There is now a large literature on the
application of mixed-effects modelling to agricultural and ecological
science, and we refer the reader to this (Peek \emph{et al.} , 2002,
Bolker \emph{et al.} (2009),), Zuur, Bates). In our current context, the
response of the flux to measured covariates (radiation, temperature,
etc.) represent fixed effects. Spatial variability (i.e.~variation which
is not explained by a covariate, but by spatial location) represents a
random effect. If we consider the domain around the tower as sub-divided
into a number of spatial regions, \(s\) (e.g.~the squares in Figure
\ref{fig:fp_on_map_Stordalen}), the local mean within each will be
higher or lower than the domain average, after accounting for fixed
effects. We can represent this as a random effect, adding a random
intercept term \(b_s\) to Equation \ref{eq:timeVarn}

\begin{equation}
   \label{eq:mixed}


  F_{ts} &= \boldsymbol{\beta} \mathbf{X}_t + b_s + \epsilon_{ts} \\
  b_s & \sim N(0, \Psi), \\
  \epsilon_{ts} & \sim N(0, \sigma^2).

\end{split}

\end{equation}

That is, we fit a fixed-effect model which describes the global response
of the flux to independent variables, but allow the flux to be
consistently higher or lower in each spatial region through the random
intercept term \(b_s\). The random effects \(b_s\) are assumed to be
independently drawn from a normal distribution with mean zero and
variance \(\Psi\), and it is this variance that is estimated. To
calculate the \(b_s\) terms, we require the footprint weighting for each
spatial region \(s\) at time \(t\), given by:

\begin{align}
   \label{eq:sWtMean} 
  W_{ts} = \sum_{x = 1}^{n_x} \sum_{y = 1}^{n_y}  \sum_{s = 1}^{n_s} [S_{xy} = s] W_{xyt}

\end{align}

where \(\mathbf{S}\) is the matrix of \(n_s\) spatial regions and the
square brackets are Iverson notation, evaluating to 1 where true and
zero otherwise.

In many cases, we can classify the landscape as a set of discrete
surface types forming a heterogeneous matrix,
\(\mathbf{U} = \{U_{xy}\}\). In our subarctic mire example, the surface
types could simply be water or land (Figure \ref{fig:r_water_land}), or
the more detailed set \(\mathbf{u}\) = \{hummock, semi-wet, wet,
graminoid, water\} (Figure \ref{fig:r_u5}). The footprint weighting for
each surface type \(u\) at time \(t\) is:

\begin{align}
   \label{eq:uWtMean} 
  W_{tu} = \sum_{x = 1}^{n_x} \sum_{y = 1}^{n_y}  \sum_{u = 1}^{n_u} [U_{xy} = u] W_{xyt}.

\end{align}

More realistically, rather than specifying constant intercept terms, we
can allow the model parameters to vary among the different surface
types, so that we estimate the flux from each surface type \(u\) in each
spatial region \(s\) at time \(t\) as:

\begin{align}
   \label{eq:lmerModel_ust} 
  F_{tsu} &= \boldsymbol{\beta}_u \mathbf{X}_t + \mathbf{b}_s \mathbf{Z}_{ts} + \epsilon_{tsu}

\end{align}

where \(\mathbf{Z}_{ts}\) is the so-called ``design matrix'' which
specifies the group structure and the explanatory variables.
Additionally, it is common that the residuals \(\epsilon_{t}\) are
autocorrelated, and we can account for this by introducing a first-order
autoregressive error term:

\begin{align}
   \label{eq:lmerModel_ar_ust} 
  F_{tsu} &= \boldsymbol{\beta}_u \mathbf{X}_t + \mathbf{b}_s \mathbf{Z}_{ts} + \phi_{1}F_{t-1,su} + \epsilon_{tsu}.

\end{align}

We thus estimate the measured flux at time \(t\) to be:

\begin{align}
   \label{eq:pred_Fbarhat} 
  \widehat{\bar{F_t}} &= \sum_{u = 1}^{n_u} \boldsymbol{\beta}_u \mathbf{X}_t W_{tu} 
                       + \sum_{s = 1}^{n_s} \mathbf{b}_s \mathbf{Z}_{ts} W_{ts} 
                       + \phi_{1}F_{t-1} + \epsilon_{t}  

\end{align}

The model fitted to observations of \(\widehat{\bar{F_t}}\) can be used
to make explicit predictions of \(\bar{F_t}\) over a wider domain, if
the area covered by each surface type is available (and any other
spatial covariates). In this case, the spatial terms, being random
effects with mean zero, drop out to leave our model for the predicted
domain-mean CH\(_4\) flux as:

\begin{align}
   \label{eq:pred_Fbar} 
  \bar{F_t} &= \sum_{u = 1}^{n_u} \boldsymbol{\beta}_u \mathbf{X}_t A_{u} \frac{1}{n_x n_y l^2}.

\end{align}

where \(A_{u}\) denotes the area occupied by surface type \(u\) and
\(l^2\) is the area of a single grid square.

Given that the different surface types may respond to different
independent variables, we can specify different fixed-effect terms for
each. For example, fluxes from water may respond to water temperature,
whereas fluxes from land may respond to soil temperature. The parameters
of mixed-effect models are typically estimated by maximum likelihood
estimation. Here we use Bayesian methods instead, using Hamiltonian
Markov chain Monte Carlo sampling, which provides a computationally
efficient means of estimating the posterior distribution of the
parameters (Betancourt, 2017). This allows us to combine data from flux
chambers within the footprint as informative priors, and provides a
robust means of estimating uncertainty on the parameters and
predictions.

\subsection{Case study: methane fluxes in a subarctic
wetland}\label{case-study-methane-fluxes-in-a-subarctic-wetland}

We apply the approach outlined above to a case study of methane fluxes
in a subarctic wetland (Jammet \emph{et al.} , 2017). Methane (CH\(_4\))
is an important greenhouse gas, and has other damaging effects related
to stratospheric ozone, aerosols and water vapour (Myhre \emph{et al.} ,
2013). The recent increase in global atmospheric CH\(_4\) concentration
has been attributed to a rise in emissions from natural wetlands, as
well as fossil fuel use (Kirschke \emph{et al.} , 2013). Boreal and
arctic wetlands comprise around 50 \% of the global wetland area (Lehner
\& Döll, 2004), and have experienced a temperature increase of almost
double the global rate (IPCC, 2013). If this has has the effect of
promoting arctic CH\(_4\) emissions, there is the potential for a
positive feedback on global warming. The magnitude and controls on
arctic CH\(_4\) fluxes remain highly uncertain (Kirschke \emph{et al.} ,
2013), largely due to the heterogeneous nature of the ecosystems. Based
on field studies using static chamber methods (Matson 2000), CH\(_4\)
fluxes are known to be influenced by factors such as soil temperature,
water table height, soil moisture, active layer thaw depth and
vegetation type (Zona \emph{et al.} , 2009, Sturtevant \emph{et al.} 
(2012), Levy \emph{et al.} (2012), Davidson \emph{et al.} (2016)). We
need to understand these responses if we are to correctly predict the
effects of future climate change. However, extrapolating to larger
scales from these point measurements is difficult, given the small scale
of the measurements and the extent of the spatial heterogeneity (van
Oijen \emph{et al.} , 2017). Using the modelling approach described above
applied to a subarctic ecosystem where there are clear differences in
surface characteristics within the landscape, we demonstrate the
inference of spatial heterogeneity in CH\(_4\) flux. Our aims here were
to:

\begin{itemize}
\item
  quantify and account for the spatial heterogeneity in CH\(_4\) flux
  around the tower
\item
  combine information from flux chamber and eddy covariance methods in a
  coherent way
\item
  describe the response of CH\(_4\) fluxes to environmental variables,
  accounting for spatial variability\\
\item
  quantify the uncertainty in upscaling eddy covariance measurements to
  a wider region

\end{itemize}

With this case study, we aimed to show that the approach aids the
interpretation of eddy covariance measurements, and maximises the
information content which can be retrieved from the data.